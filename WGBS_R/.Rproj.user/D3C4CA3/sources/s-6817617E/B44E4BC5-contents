library("tidyverse")
library("DESeq2")
library("ggplot2")
library("hexbin")
library("genefilter")
library("pheatmap")
library("clusterProfiler")
library("gghighlight")
library(RColorBrewer)
library(Cairo)

#Gene Ontology (GO) classifies functions along molecular function (molecular activities), cellular component (where gene products are active), and biological process (pathways and larger processes)
#We have 60609 genes detected, with 3962 that were differentially expressed (padj < 0.05) across samples 
#We selected padj < 0.05 as the differential genes 
#Now we need to evaluate whether those 3962 genes are over-represented in the gene set using hypergeometric distribution 
#and use gene set enrichment analysis (GSEA) to find genes where the difference is large 
#Input into clusterProfiler is a ranked list of genes (i.e., ControlvsCRISPRi_results.csv")

#Look at up-regulated and down-regulated genes together and separately. Could ZNF384 have any implications in chromatin topology?!

#selected 3962 genes with padj < 0.05 
CRISPRi_genes_padj <- as.data.frame(read.csv("ControlvsCRISPRi_results.csv"))
CRISPRi_genes_padj_entrez <- as.character(CRISPRi_genes_padj$entrez)

#selected 1484 genes with log2foldchange outside of (+/-)1.5 and padj < 0.05 
CRISPRi_genes_log2fc_1.5 <- CRISPRi_genes_padj %>%
  filter(log2FoldChange < -1.5 | log2FoldChange > 1.5)
CRISPRi_genes_log2fc_1.5_entrez <- as.character(CRISPRi_genes_log2fc_1.5$entrez)

#selected 28 genes with log2foldchange outside of +1.5 and padj < 0.05 
CRISPRi_genes_log2fc_upreg <- CRISPRi_genes_padj %>%
  filter(log2FoldChange > 1.5)
CRISPRi_genes_log2fc_upreg_entrez <- as.character(CRISPRi_genes_log2fc_upreg$entrez)

#selected 1456 genes with log2foldchange outside of -1.5 and padj < 0.05 
CRISPRi_genes_log2fc_downreg <- CRISPRi_genes_padj %>%
  filter(log2FoldChange < -1.5)
CRISPRi_genes_log2fc_downreg_entrez <- as.character(CRISPRi_genes_log2fc_downreg$entrez)

#BP = biological pathways; MF = Molecular Function; CC = Cellular Component 
#OrgDb = gene-based information for a given organsism; keyType = keytype of input gene; qvalueCuttoff = FDR
#Gene ontology (GO) for this gene set 
#GO Enrichment analysis of a gene set. Given a vector of genes, this function will return the enrichment GO categories after FDR control

######selected 3962 genes with padj < 0.05 ######
######Biological Process######
CRISPRi_GO <- enrichGO(CRISPRi_genes_padj,
                        ont = "BP",
                        OrgDb="org.Hs.eg.db",
                        pvalueCutoff = 0.05,
                        keyType = "ENTREZID",
                        pAdjustMethod = "BH")

dotplot(CRISPRi_GO,
        title = "Padj < 0.05 Ontology",
        showCategory = 15)

######Molecular Function######
CRISPRi_GO_MF <- enrichGO(CRISPRi_genes_padj,
                       ont = "MF",
                       OrgDb="org.Hs.eg.db",
                       pvalueCutoff = 0.05,
                       keyType = "ENTREZID",
                       pAdjustMethod = "BH")

dotplot(CRISPRi_GO_MF,
        title = "Padj < 0.05 MF Ontology",
        showCategory = 15)

######Cellular Component######
CRISPRi_GO_CC <- enrichGO(CRISPRi_genes_padj,
                          ont = "CC",
                          OrgDb="org.Hs.eg.db",
                          pvalueCutoff = 0.05,
                          keyType = "ENTREZID",
                          pAdjustMethod = "BH")

dotplot(CRISPRi_GO_CC,
        title = "Padj < 0.05 CC Ontology",
        showCategory = 15)

############################################################
#selected 1484 genes with log2foldchange outside of (+/-)1.5 and padj < 0.05 
######Biological Process######
CRISPRi_genes_log2fc_1.5 <- enrichGO(CRISPRi_genes_log2fc_1.5,
                       ont = "BP",
                       OrgDb="org.Hs.eg.db",
                       pvalueCutoff = 0.05,
                       keyType = "ENTREZID",
                       pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_1.5, 
        showCategory = 20,
        title = "L2fc(+/-1.5) Ontology")

######Molecular Function######
CRISPRi_genes_log2fc_1.5_MF <- enrichGO(CRISPRi_genes_log2fc_1.5_entrez,
                                     ont = "MF",
                                     OrgDb="org.Hs.eg.db",
                                     pvalueCutoff = 0.05,
                                     keyType = "ENTREZID",
                                     pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_1.5, 
        showCategory = 20,
        title = "L2fc(+/-1.5) MF Ontology")

######Cellular Component######
CRISPRi_genes_log2fc_1.5_CC <- enrichGO(CRISPRi_genes_log2fc_1.5,
                                        ont = "CC",
                                        OrgDb="org.Hs.eg.db",
                                        pvalueCutoff = 0.05,
                                        keyType = "ENTREZID",
                                        pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_1.5, 
        showCategory = 20,
        title = "L2fc(+/-1.5) CC Ontology")

#selected 28 genes with log2foldchange outside of +1.5 and padj < 0.05 
############################################################
######Biological Process######
CRISPRi_genes_log2fc_upreg <- enrichGO(CRISPRi_genes_log2fc_upreg,
                        ont = "BP",
                        OrgDb="org.Hs.eg.db",
                        pvalueCutoff = 0.05,
                        keyType = "ENTREZID",
                        pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_upreg, 
        showCategory = 20,
        title = "L2fc +1.5 Ontology")

######Molecular Function######
CRISPRi_genes_log2fc_upreg <- enrichGO(CRISPRi_genes_log2fc_upreg,
                                       ont = "MF",
                                       OrgDb="org.Hs.eg.db",
                                       pvalueCutoff = 0.05,
                                       keyType = "ENTREZID",
                                       pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_upreg, 
        showCategory = 20,
        title = "L2fc +1.5 MF Ontology")

######Cellular Component######
CRISPRi_genes_log2fc_upreg <- enrichGO(CRISPRi_genes_log2fc_upreg,
                                       ont = "CC",
                                       OrgDb="org.Hs.eg.db",
                                       pvalueCutoff = 0.05,
                                       keyType = "ENTREZID",
                                       pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_upreg, 
        showCategory = 20,
        title = "L2fc +1.5 CC Ontology")

#selected 1456 genes with log2foldchange outside of -1.5 and padj < 0.05 
############################################################
######Biological Process######
CRISPRi_genes_log2fc_downreg <- enrichGO(CRISPRi_genes_log2fc_downreg,
                        ont = "BP",
                        OrgDb="org.Hs.eg.db",
                        pvalueCutoff = 0.05,
                        keyType = "ENTREZID",
                        pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_downreg, 
        showCategory = 20,
        title = "L2fc -1.5 Ontology")

######Molecular Function######
CRISPRi_genes_log2fc_downreg <- enrichGO(CRISPRi_genes_log2fc_downreg,
                                         ont = "MF",
                                         OrgDb="org.Hs.eg.db",
                                         pvalueCutoff = 0.05,
                                         keyType = "ENTREZID",
                                         pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_downreg, 
        showCategory = 20,
        title = "L2fc -1.5 MF Ontology")

######Cellular Component######
CRISPRi_genes_log2fc_downreg <- enrichGO(CRISPRi_genes_log2fc_downreg,
                                         ont = "CC",
                                         OrgDb="org.Hs.eg.db",
                                         pvalueCutoff = 0.05,
                                         keyType = "ENTREZID",
                                         pAdjustMethod = "BH")

dotplot(CRISPRi_genes_log2fc_downreg, 
        showCategory = 20,
        title = "L2fc -1.5 CC Ontology")













cluster4_GO <- enrichGO(cluster4_genes$gene,
                        ont = "BP",
                        OrgDb="org.Hs.eg.db",
                        pvalueCutoff = 0.05,
                        keyType = "ENSEMBL",
                        pAdjustMethod = "BH")
dotplot(cluster4_GO, 
        showCategory = 20,
        title = "Cluster 4 Ontology")

cluster5_GO <- enrichGO(cluster5_genes$gene,
                        ont = "BP",
                        OrgDb="org.Hs.eg.db",
                        pvalueCutoff = 0.05,
                        keyType = "ENSEMBL",
                        pAdjustMethod = "BH")
dotplot(cluster5_GO, 
        showCategory = 20,
        title = "Cluster 5 Ontology")

cluster5_GO_interferon <- cluster5_GO_df %>% dplyr::filter(str_detect(tolower(Description), pattern = "interferon"))
  

cluster5_GO_interferon <- separate(cluster5_GO_interferon,
                          geneID,
                          into = sprintf('%s.%s', rep("gene", 33), rep(1:33, each=1)),
                          extra = "merge",
                          fill = "right") %>%
  dplyr::select(2, 8:40)
cluster5_GO_interferon <- pivot_longer(cluster5_GO_interferon, cols = 2:34, names_to = "genes") %>%
  dplyr::select(1,3) 

cluster5_GO_interferon_genes <- unique(cluster5_GO_interferon$value)
cluster5_GO_interferon_genes <- as.data.frame(as.character(cluster5_GO_interferon_genes))
write_csv(cluster5_GO_interferon, "cluster5_GO_interferon_genes.csv")

